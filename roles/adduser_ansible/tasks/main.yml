---

- name: Create user group(s)
  group:
    name: "{{ user_usergroup }}"
    state: present
  become: true

- name: Create user
  user:
    groups: "{{ (user_groups | join(',')) }}"
    append: yes
    name: "{{ user_name }}"
    shell: "{{ user_shell }}"
  become: true

- name: Enable passwordless sudo
  copy:
    content: "{{ user_name }} ALL=(ALL) NOPASSWD:ALL"
    dest: "/etc/sudoers.d/{{ user_name }}"
    owner: "root"
    group: "root"
    mode: "0440"
  when: user_passwordless_sudo
  become: true

- name: Set authorized_key to allow SSH key based logins
  authorized_key:
    user: "{{ user_name }}"
    key: "{{ lookup('file', user_ssh_key_path) }}"
  become: true


